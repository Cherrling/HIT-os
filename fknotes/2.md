### 2. 保护模式内存管理

#### 2.1. 内存管理概览


- **逻辑地址**：也称为虚拟地址，是程序在运行时生成的地址。逻辑地址是由程序员编写的代码所使用的地址，通常是相对于某个基址的偏移量。

- **线性地址**：在保护模式下，逻辑地址经过段选择符和偏移量的转换后，形成的地址称为线性地址。线性地址是一个连续的地址空间，操作系统可以在此基础上进行内存管理。

- **物理地址**：是计算机内存中实际的物理地址。物理地址是由内存控制器使用的地址，直接对应于内存芯片中的存储单元。

逻辑地址通过段机制转换为线性地址，线性地址再通过页表转换为物理地址。

#### 2.2. 分段机制


1. **Basic Flat Model**：
   - 在基本平面模型中，整个内存被视为一个单一的段。所有的逻辑地址都直接映射到线性地址，简化了内存管理。
   - 这种模型适用于简单的应用程序，易于实现，但缺乏灵活性和安全性。

2. **Protected Flat Model**：
   - 保护平面模型在基本平面模型的基础上增加了保护机制。每个段都有自己的权限和访问控制，防止程序之间的相互干扰。
   - 这种模型允许多个程序在同一内存空间中运行，同时提供了更高的安全性和稳定性。

3. **Multi-Segment Model**：
   - 多段模型将程序划分为多个逻辑段，每个段可以独立管理。每个段可以有不同的大小和权限，适合复杂的应用程序。
   - 这种模型提供了更大的灵活性，允许程序根据需要动态分配和释放内存，同时也支持更复杂的内存保护机制。

### 2.3. 逻辑地址和线性地址的转换

在保护模式下，逻辑地址转换为线性地址的过程涉及几个关键概念：

#### 段选择子 
- 段选择子是一个16位的值，用于选择特定的段描述符。它包含了段的索引、特权级和一些标志位。
- 段选择子并不直接指向物理内存，而是指向段描述符表中的一个条目。

#### 段寄存器 
- 段寄存器是CPU中的寄存器，用于存储段选择子。常见的段寄存器包括：CS（代码段）、DS（数据段）、SS（堆栈段）、ES、FS、GS等。
- 加载段寄存器的过程通常通过指令（如 `MOV` 指令）来完成，操作系统在程序加载时会设置这些寄存器。

#### 段描述子 
- 段描述子是一个数据结构，包含了段的基址、界限、访问权限等信息。每个段都有一个对应的段描述子。
- 段描述子的结构通常包括以下字段：
  - 基址：段的起始地址。
  - 界限：段的大小。
  - 访问权限：描述段的可访问性和特权级。
  - 状态：指示段的类型（代码段、数据段等）。

#### 逻辑地址转换为线性地址的过程
当处理器将逻辑地址转换为线性地址时，主要执行以下步骤：
1. **获取段选择子**：从段寄存器中获取段选择子。
2. **查找段描述子**：根据段选择子在全局描述符表（GDT）或局部描述符表（LDT）中查找对应的段描述子。
3. **计算基址**：从段描述子中提取基址。
4. **计算线性地址**：将逻辑地址中的偏移量与基址相加，得到线性地址。

### 2.4. 描述符的分类

1. **数据段描述符**：
   - **基址**：指向数据段在内存中的起始地址。
   - **界限**：定义数据段的大小，限制访问该段的最大地址。
   - **访问权限**：包括读、写权限和特权级别，确保只有具有适当权限的代码可以访问该段。
   - **用途**：用于存储程序的全局变量、静态数据和动态分配的内存（如堆）。

2. **代码段描述符**：
   - **基址**：指向代码段在内存中的起始地址。
   - **界限**：定义代码段的大小，限制可执行代码的范围。
   - **访问权限**：通常包括可执行权限和读取权限，确保代码段只能被执行而不能被写入。
   - **用途**：存储程序的可执行代码，确保代码的安全性和完整性。

3. **局部描述符表描述符**：
   - **基址**：指向局部描述符表的起始地址。
   - **界限**：定义局部描述符表的大小。
   - **访问权限**：控制对局部描述符表的访问权限。
   - **用途**：局部描述符表用于存储特定于某个任务的段描述符，允许任务拥有自己的段描述符集，增强了多任务处理的灵活性。

4. **任务状态段描述符**：
   - **基址**：指向任务状态段的起始地址。
   - **界限**：定义任务状态段的大小。
   - **访问权限**：控制对任务状态段的访问权限。
   - **用途**：存储任务的状态信息，包括寄存器的值、堆栈指针、任务的优先级等。任务状态段在任务切换时被使用，以保存和恢复任务的上下文。

5. **调用门描述符**：
   - **基址**：指向被调用的高特权级代码的入口地址。
   - **界限**：通常不适用，因为调用门描述符主要用于指向代码段。
   - **访问权限**：定义调用门的访问权限，确保只有具有适当权限的代码可以通过调用门进行调用。
   - **用途**：实现特权级之间的调用，允许低特权级的代码安全地调用高特权级的服务，如操作系统内核的功能。

6. **中断门描述符**：
   - **基址**：指向中断处理程序的入口地址。
   - **界限**：通常不适用，因为中断门描述符主要用于指向中断处理程序。
   - **访问权限**：确保只有高特权级的代码可以触发中断。
   - **用途**：处理中断请求，允许中断处理程序在高特权级下执行，确保系统能够及时响应外部事件。

7. **陷阱门描述符**：
   - **基址**：指向异常处理程序的入口地址。
   - **界限**：通常不适用，因为陷阱门描述符主要用于指向异常处理程序。
   - **访问权限**：确保只有高特权级的代码可以触发陷阱。
   - **用途**：用于处理异常和陷阱，允许程序在高特权级下处理异常情况，如除零错误或无效操作码。

8. **任务门描述符)**：
   - **基址**：向任务状态段的起始地址。
   - **界限**：通常不适用，因为任务门描述符主要用于指向任务状态段。
   - **访问权限**：控制对任务门的访问权限，确保只有具有适当权限的代码可以触发任务切换。
   - **用途**：用于任务切
