### 3. 中断和异常处理

#### 3.1. 中断和异常处理概述

**什么是中断和异常？**

- **中断**：中断是由外部设备（如键盘、鼠标、硬盘等）发出的信号，通知处理器需要处理某个事件。中断可以是硬件中断（由外部设备产生）或软件中断（由程序内部产生，如系统调用）。中断允许处理器在执行当前任务时，暂时中断并转向处理其他更紧急的任务。

- **异常**：异常是由处理器在执行程序时检测到的特定条件，通常是由于程序错误或特定事件（如除零错误等）引起的。异常可以被视为一种特殊类型的中断，通常是由程序内部的错误或特定情况引发的。

**处理器如何处理？**

处理器处理中断和异常的基本步骤如下：

1. **中断/异常信号的接收**：当中断或异常发生时，处理器会接收到相应的信号。
2. **保存上下文**：处理器会保存当前执行的上下文，以便在处理完中断或异常后能够恢复执行。
3. **查找中断向量**：处理器会根据中断或异常的类型查找中断向量表，获取相应的处理程序地址。
4. **执行中断处理程序**：处理器跳转到中断处理程序，执行相应的处理逻辑。
5. **恢复上下文**：处理完中断或异常后，处理器会恢复之前保存的上下文，继续执行被中断的程序。

**思考：实模式和保护模式下，中断向量表一样吗？**

在实模式和保护模式下，中断向量表的结构和使用方式有所不同：

- **实模式**：在实模式下，中断向量表位于内存的固定位置，每个中断向量占用4个字节。实模式下的中断向量表是简单的线性结构，处理器直接通过中断号访问。

- **保护模式**：在保护模式下，中断向量表的概念有所扩展，通常使用中断描述符表。IDT允许更复杂的中断处理机制，包括特权级别、任务切换等。IDT的每个条目可以包含更多的信息，如中断处理程序的段选择子和偏移量，以及中断的特权级别等。

### 3.2. 有关中断和异常了解性的内容

#### 中断和异常向量

- **中断向量**：中断向量是一个指向中断处理程序的地址的指针。每个中断都有一个唯一的中断号，处理器通过中断号查找中断向量表，以找到相应的中断处理程序。

- **异常向量**：异常向量与中断向量类似，但它们专门用于处理异常情况。每个异常也有一个唯一的异常号，处理器通过异常号查找异常处理程序。

#### 中断源和异常源

- **中断源**：中断源是指产生中断信号的外部设备或内部事件。例如，键盘输入、网络数据包到达、定时器溢出等都可以作为中断源。

- **异常源**：异常源是指在程序执行过程中产生的错误或特定条件。例如，除零错误、无效操作码、访问违规等都可以作为异常源。

#### 异常的分类：故障、陷阱和中止

- **故障**：故障是指在程序执行过程中发生的可恢复的异常。处理器会中断当前程序的执行，转而执行异常处理程序，处理完后可以恢复程序的执行。例如，页面错误通常是故障。

- **陷阱**：陷阱是由程序主动引发的异常，通常用于调试或系统调用。陷阱允许程序在执行过程中请求操作系统的服务。例如，系统调用通常会引发陷阱。

- **中止**：中止是指不可恢复的异常，通常表示严重错误，处理器会终止当前程序的执行，无法恢复。例如，硬件故障或严重的内存错误。

#### 程序或任务的重新执行

在处理故障或某些类型的异常时，处理器可以选择重新执行导致异常的指令。这通常发生在故障的情况下，处理器在处理完异常后会恢复到异常发生前的状态，并重新执行指令。

#### 开启和禁止中断

- **开启中断**：允许处理器响应外部中断信号。通常在操作系统的调度或任务切换时会开启中断，以便处理外部事件。

- **禁止中断**：禁止处理器响应外部中断信号。通常在关键代码段或临界区执行时会禁止中断，以防止中断导致数据不一致或状态混乱。

#### 异常和中断的优先级

中断和异常的优先级决定了在多个中断或异常同时发生时，处理器应该优先处理哪个。优先级通常由硬件设计决定，处理器会根据优先级顺序处理不同的中断和异常。高优先级的中断或异常会打断低优先级的处理程序，确保系统能够及时响应重要事件。优先级的管理对于实时系统和多任务操作系统尤为重要。


### 3.3. 中断描述符表

#### 如何构成？

中断描述符表是一个数据结构，用于存储中断和异常的处理程序信息。IDT的构成如下：

1. **条目数量**：IDT的大小通常为256个条目，每个条目对应一个中断或异常。

2. **每个条目的结构**：每个IDT条目通常包含以下信息：
   - **中断处理程序的段选择子**：指向中断处理程序所在代码段的选择子。
   - **中断处理程序的偏移量**：中断处理程序在代码段中的偏移地址，通常分为高16位和低16位。
   - **类型和属性**：指示该条目的类型和特权级别，用于控制访问权限。
   - **保留位**：用于将来扩展或其他目的的保留位。

3. **内存位置**：IDT通常位于内存的某个特定位置，操作系统在初始化时会设置该位置。

#### 如何获得中断处理程序的地址？

要获得中断处理程序的地址，处理器会根据中断或异常的类型查找IDT。具体步骤如下：

1. **中断或异常发生**：当中断或异常发生时，处理器会生成一个中断号或异常号。

2. **查找IDT**：处理器使用中断号或异常号作为索引，查找IDT中对应的条目。

3. **获取地址**：从IDT条目中提取中断处理程序的段选择子和偏移量，组合成完整的地址，跳转到该地址执行中断处理程序。

#### 如何设置中断描述符表寄存器？

设置中断描述符表寄存器的步骤如下：

1. **准备IDT的基地址和界限**：
   - **基地址**：确定中断描述符表在内存中的起始地址。
   - **界限**：计算IDT的大小，通常是IDT条目数乘以每个条目的大小。

2. **构建IDTR结构**：
   - 创建一个结构体或数据结构，包含两个字段：一个用于存储IDT的界限，另一个用于存储IDT的基地址。

3. **加载IDTR**：
   - 使用特定的指令（如`lidt`指令）将IDTR的内容加载到处理器中。这条指令会将IDT的基地址和界限信息写入IDTR寄存器，使处理器能够正确地访问IDT。

### 3.4. IDT 描述符

#### 1. 中断门格式

中断门描述符的格式通常如下：

- **0-15位**：偏移量低16位
- **16-31位**：选择子
- **32-39位**：保留位
- **40-41位**：类型和属性
  - 其中包括：
    - 0-3位：类型，指示这是一个中断门。
    - 4位：系统位，指示是否为系统描述符。
    - 5位：DPL，描述符特权级别。
    - 6位：P，指示描述符是否有效。
- **42-63位**：偏移量高16位

#### 2. 陷阱门格式

陷阱门描述符的格式与中断门类似，主要区别在于类型和属性字段：

- **0-15位**：偏移量低16位
- **16-31位**：选择子
- **32-39位**：保留位
- **40-41位**：类型和属性
  - 其中包括：
    - 0-3位：类型，指示这是一个陷阱门。
    - 4位：系统位，指示是否为系统描述符。
    - 5位：DPL，描述符特权级别。
    - 6位：P，指示描述符是否有效。
- **42-63位**：偏移量高16位

#### 3. 任务门格式

任务门描述符的格式与中断门和陷阱门有所不同，主要用于任务切换：

- **0-15位**：保留位
- **16-31位**：选择子，指向任务状态段。
- **32-39位**：保留位
- **40-41位**：类型和属性
  - 其中包括：
    - 0-3位：类型，指示这是一个任务门。
    - 4位：系统位，指示是否为系统描述符。
    - 5位：DPL，描述符特权级别。
    - 6位：P，指示描述符是否有效。
- **42-63位**：保留位

### 3.5. 中断与异常处理

1. **中断过程调用的流程是怎样的？**  
   中断过程调用的流程包括保存当前上下文、查找中断向量、执行中断处理程序、恢复上下文并返回。

2. **如何判断中断处理过程与被中断任务的优先级？**  
   通过比较中断的优先级与当前执行任务的优先级，决定是否允许中断处理。

3. **不同优先级上，处理方式一样吗？**  
   不同优先级的中断处理方式可能不同，高优先级中断可以打断低优先级任务的执行。

4. **如果发生堆栈切换，处理器会做哪些操作？**  
   处理器会保存当前堆栈指针，加载新的堆栈指针，并切换到新的堆栈段。

5. **如果没发生堆栈切换，处理器会做哪些操作？**  
   处理器会直接保存当前上下文，继续使用原有堆栈进行中断处理。

6. **中断处理过程后，如何返回，处理器做了哪些操作？**  
   中断处理完成后，处理器会恢复之前保存的上下文，并使用特定指令返回到被中断的任务。

7. **异常和中断处理过程的保护**  
   处理器通过特权级别和上下文保存机制来保护异常和中断处理过程，防止不当访问。

8. **异常和中断处理过程的标志使用方式**  
   标志寄存器用于保存中断和异常处理前的状态，以便在处理完成后恢复。

9. **中断门与陷阱门的唯一区别是什么？**  
   中断门用于处理硬件中断，而陷阱门用于处理软件异常和系统调用。